<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'flat-1_2.dtd'>
<nta>
   <declaration>
  	int New_Mode_Flag;
  	int initial_flag;
  	int Running_Mode;
  	int Set_Button;
  	int Start_Button;
  	int Standby_Button;
  	int check_flag_VCV;
  	int In_Init_Flag;
  	int In_Start_Tick;
  	int InEx_Flag;
  	int peep_observed;
  	int In_End_Tick;
  	int Ex_Init_Flag;
  	int p_plateau_flag;
  	int p_plateau_cycles;
  	int p_plateau;
  	int Exhale_Time;
  	int Inhale_Time;
  	int ExtraDelayFlag;
  	int volumeORpressureMode;
  	int Sensors_Running;
  	int check_flag_sensors;
  	int VCVmodeHandle;
  	int SensorsHandle;
  	int txx[13];
  	int cmd_end[3];
  	int t3;
  	int VCV_InRet;
      void get_pressure (){}
      void find_peep (){}
      void set_flow (){}
      void Suspend_All_Modes (){}
      void Update_Control_Parameters (){}


// Posting Declarations from all templates here:

   </declaration>
   <template>
//TEMPLATE_RETURN_TYPE:void
      <name>Start_VCVmode</name>
      <parameter>int argument </parameter>
      <location id="id0" x="1500" y="10">
      <name>Loc0</name>
      </location>
      <location id="id1" x="1650" y="250">
      <name>Loc1</name>
      </location>
      <location id="id2" x="1800" y="10">
      <name>Loc2</name>
      </location>
      <location id="id3" x="1950" y="250">
      <name>Loc3</name>
      </location>
      <location id="id4" x="2100" y="10">
      <name>Loc4</name>
      </location>
      <location id="id5" x="2250" y="250">
      <name>Loc5</name>
      </location>
      <location id="id6" x="2400" y="10">
      <name>Loc6</name>
      </location>
      <location id="id7" x="2550" y="250">
      <name>Loc7</name>
      </location>
      <location id="id8" x="2700" y="10">
      <name>Loc8</name>
      </location>
      <location id="id9" x="2850" y="250">
      <name>Loc9</name>
      </location>
      <location id="id10" x="3000" y="10">
      <name>Loc10</name>
      </location>
      <location id="id11" x="3150" y="250">
      <name>Loc11</name>
      </location>
      <location id="id12" x="3300" y="10">
      <name>Loc12</name>
      </location>
      <location id="id13" x="3450" y="250">
      <name>Loc13</name>
      </location>
      <location id="id14" x="3600" y="10">
      <name>Loc14</name>
      </location>
      <location id="id15" x="3750" y="250">
      <name>Loc15</name>
      </location>
      <location id="id16" x="3900" y="10">
      <name>Loc16</name>
      </location>
      <location id="id17" x="4050" y="250">
      <name>Loc17</name>
      </location>
      <location id="id18" x="4200" y="10">
      <name>Loc18</name>
      </location>
      <location id="id19" x="4350" y="250">
      <name>Loc19</name>
      </location>
      <location id="id20" x="4500" y="10">
      <name>Loc20</name>
      </location>
      <location id="id21" x="4650" y="250">
      <name>Loc21</name>
      </location>
      <location id="id22" x="4800" y="10">
      <name>Loc22</name>
      </location>
      <location id="id23" x="4950" y="250">
      <name>Loc23</name>
      </location>
      <location id="id24" x="5100" y="10">
      <name>Loc24</name>
      </location>
      <location id="id25" x="5250" y="250">
      <name>Loc25</name>
      </location>
      <location id="id26" x="5400" y="10">
      <name>Loc26</name>
      </location>
      <location id="id27" x="5550" y="250">
      <name>Loc27</name>
      </location>
      <location id="id28" x="5700" y="10">
      <name>Loc28</name>
      </location>
      <location id="id29" x="5850" y="250">
      <name>Loc29</name>
      </location>
      <location id="id30" x="6000" y="10">
      <name>Loc30</name>
      </location>
      <location id="id31" x="6150" y="250">
      <name>Loc31</name>
      </location>
      <location id="id32" x="6300" y="10">
      <name>Loc32</name>
      </location>
     <init ref="id0"/>
    <!-- USER CODE BEGIN Start_VCVmode--> 
    <!-- Infinite loop--> 
    <!-- for(;;) --> 
    <!-- { --> 
    <transition>
        <source ref="id0"/>
        <target ref="id1"/>
        <label kind="guard">New_Mode_Flag</label>
        <label kind="assignment">		New_Mode_Flag = 0
		</label>    </transition> 
    <transition>
        <source ref="id1"/>
        <target ref="id2"/>
        <label kind="guard">initial_flag</label>
        <label kind="assignment">		initial_flag = 0,
		t3 = HAL_GetTick()
		</label>    </transition> 
    <transition>
        <source ref="id2"/>
        <target ref="id3"/>
        <label kind="guard">Running_Mode!=1</label>
        <label kind="assignment">		osThreadSuspend(VCVmodeHandle)
		</label>    </transition> 
    <transition>
        <source ref="id3"/>
        <target ref="id4"/>
        <label kind="guard">Set_Button</label>
        <label kind="assignment">		Set_Button = 0,
		volumeORpressureMode = 0,
		Update_Internal_Parameters(),
		Update_Control_Parameters()
		</label>    </transition> 
    <transition>
        <source ref="id4"/>
        <target ref="id5"/>
        <label kind="guard">Start_Button</label>
        <label kind="assignment">		Start_Button = 0,
		osThreadResume(SensorsHandle),
		Sensors_Running = 1,
		Update_Internal_Parameters(),
		Update_Control_Parameters()
		</label>    </transition> 
    <transition>
        <source ref="id5"/>
        <target ref="id6"/>
        <label kind="guard">Standby_Button</label>
        <label kind="assignment">		Standby_Button = 0,
		HAL_DAC_Stop_DMA(hdac, DAC_CHANNEL_1),
		Sensors_Running = 0,
		Suspend_All_Modes()
		</label>    </transition> 
    <transition>
        <source ref="id6"/>
        <target ref="id7"/>
        <label kind="assignment">		check_flag_VCV++</label>
    </transition>

    <transition>
        <source ref="id7"/>
        <target ref="id8"/>
        <label kind="assignment">		check_flag_sensors = 0</label>
    </transition>

    <!-- Initialization Before Inhalation--> 
    <transition>
        <source ref="id8"/>
        <target ref="id9"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOE, Pressure_SV_Pin, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id9"/>
        <target ref="id10"/>
        <label kind="assignment">		Check_Alarm_Change_To_High_Priority()</label>
    </transition>

    <transition>
        <source ref="id10"/>
        <target ref="id11"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOF, GPIO_PIN_7, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id11"/>
        <target ref="id12"/>
        <label kind="assignment">		In_Init_Flag = 1</label>
    </transition>

    <!-- INHALE CYCLE--> 
    <transition>
        <source ref="id12"/>
        <target ref="id13"/>
        <label kind="assignment">		InEx_Flag = 1</label>
    </transition>

    <transition>
        <source ref="id13"/>
        <target ref="id14"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOG, GPIO_PIN_13, GPIO_PIN_SET)</label>
    </transition>

    <transition>
        <source ref="id14"/>
        <target ref="id15"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOF, GPIO_PIN_7, GPIO_PIN_SET)</label>
    </transition>

    <transition>
        <source ref="id15"/>
        <target ref="id16"/>
        <label kind="assignment">		In_Start_Tick = HAL_GetTick()</label>
    </transition>

    <transition>
        <source ref="id16"/>
        <target ref="id17"/>
        <label kind="assignment">		VCV_InRet = osSignalWait(1,Inhale_Time)</label>
    </transition>

    <!-- Volume Cycling --> 
    <transition>
        <source ref="id17"/>
        <target ref="id18"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOF, GPIO_PIN_7, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id18"/>
        <target ref="id19"/>
        <label kind="guard">VCV_InRet.status!=osEventTimeout</label>
        <label kind="assignment">		In_End_Tick = HAL_GetTick(),
		ExtraDelayFlag = 1,
		osDelay(Inhale_Time - (In_End_Tick - In_Start_Tick)),
		ExtraDelayFlag = 0
		</label>    </transition> 
    <transition>
        <source ref="id19"/>
        <target ref="id20"/>
        <label kind="assignment">		Ex_Init_Flag = 1</label>
    </transition>

    <!-- EXHALE CYCLE--> 
    <transition>
        <source ref="id20"/>
        <target ref="id21"/>
        <label kind="assignment">		InEx_Flag = 0</label>
    </transition>

    <!-- Peak Plateau Measurement --> 
    <transition>
        <source ref="id21"/>
        <target ref="id22"/>
        <label kind="assignment">		p_plateau_cycles = p_plateau_cycles+1</label>
    </transition>

    <transition>
        <source ref="id22"/>
        <target ref="id23"/>
        <label kind="guard">p_plateau_cycles==50</label>
        <label kind="assignment">		count = 0,
		p_plateau_flag = 1,
		osDelay(5000),
		p_plateau = get_pressure(),
		txx[0] = "p",
		txx[1] = "p",
		txx[2] = "l",
		txx[3] = "a",
		txx[4] = "t",
		txx[5] = ".",
		txx[6] = "v",
		txx[7] = "a",
		txx[8] = "l",
		txx[9] = "=",
		txx[10] = p_plateau/100+"0",
		txx[11] = (p_plateau%100)/10+"0",
		txx[12] = p_plateau%10+"0",
		p_plateau_cycles = 0,
		p_plateau_flag = 0
		</label>    </transition> 
    <transition>
        <source ref="id23"/>
        <target ref="id24"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOE, Pressure_SV_Pin, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id24"/>
        <target ref="id25"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOG, GPIO_PIN_14, GPIO_PIN_SET)</label>
    </transition>

    <transition>
        <source ref="id25"/>
        <target ref="id26"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOG, GPIO_PIN_5, GPIO_PIN_SET)</label>
    </transition>

    <transition>
        <source ref="id26"/>
        <target ref="id27"/>
        <label kind="assignment">		osDelay(Exhale_Time)</label>
    </transition>

    <transition>
        <source ref="id27"/>
        <target ref="id28"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOG, GPIO_PIN_5, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id28"/>
        <target ref="id29"/>
        <label kind="assignment">		HAL_GPIO_WritePin(GPIOG, GPIO_PIN_14, GPIO_PIN_RESET)</label>
    </transition>

    <transition>
        <source ref="id29"/>
        <target ref="id30"/>
        <label kind="assignment">		Alarm_Check()</label>
    </transition>

    <transition>
        <source ref="id30"/>
        <target ref="id31"/>
        <label kind="assignment">		find_peep()</label>
    </transition>

    <transition>
        <source ref="id31"/>
        <target ref="id32"/>
        <label kind="assignment">		set_flow()</label>
    </transition>

    <!-- } --> 
    <!-- USER CODE END Start_VCVmode--> 
   </template>
<system>system Start_VCVmode;</system>
<queries>
 <query>
	  <formula></formula>
	  <comment></comment>
 </query>
</queries>
</nta>

